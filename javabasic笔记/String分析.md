# String类

String 类有 11 种构造方法，这些方法提供不同的参数来初始化字符串，比如提供一个字符数组参数：

```
char[] helloArray = { 'r', 'u', 'n', 'o', 'o', 'b'};       
String helloString = new String(helloArray);
```

**String类是不可改变的。一旦创建无法改变    StringBuffer & StringBuilder可以修改**

## String基本用法

charAt()   

substring()  左闭右开

indexOf()

lastIndexOf()

byte[] arrs = str.getBytes("GBK")  字符串与**byte数组**间的相互转换

String str1 = new String(arrs,"GBK")

**==运算符和equals之间的区别：引用指向的地址  和 引用指向的内容**

```
String str1 = "mpp";
String str2 = "mpp";  引用原str1对象
String str3 = new String("mpp");  新建一个对象  地址不同

System.out.println(str1.equals(str2)); //true  内容相同
System.out.println(str1.equals(str3));   //true  内容相同
System.out.println(str1==str2);   //true   地址相同
System.out.println(str1==str3);   //false  地址不同
```

**String的连接：**

```
public void contact () {
    //连接方式
    String s1 = "a";
    String s2 = "a";
    String s3 = "a" + s2;
    String s4 = "a" + "a";
    String s5 = s1 + s2;
    //表达式只有常量时，编译期完成计算
    //表达式有变量时，运行期才计算，所以地址不一样
    System.out.println(s3 == s4); //false
    System.out.println(s3 == s5); //f
    System.out.println(s4 == "aa"); //true

}
```

## String、String builder和String buffer的区别

String拼接字符串时会产生很多无用的中间对象  性能

StringBuffer就是为了解决大量拼接字符串时产生很多中间对象问题而提供的一个类，提供append和add方法，可以将字符串添加到已有序列的末尾或指定位置，它的本质是一个**线程安全的可修改的字符序列**，把所有修改数据的方法都加上了synchronized。但是保证了线程安全是需要性能的代价的。

在很多情况下我们的字符串拼接操作**不需要线程安全**，这时候StringBuilder登场了，StringBuilder是JDK1.5发布的，它和StringBuffer本质上没什么区别，就是**去掉了保证线程安全的那部分，减少了开销**。

***二者都继承了 AbstractStringBuilder ，底层都是利用可修改的char数组(JDK 9 以后是 byte数组)。\***

> 1、在字符串**不经常发生变化**的业务场景优先使用String(代码更清晰简洁)。如常量的声明，少量的字符串操作(拼接，删除等)。
> 
> 2、在**单线程**情况下，如有大量的字符串操作情况，应该使用StringBuilder来操作字符串。不能使用String"+"来拼接而是使用，避免产生**大量无用的中间对象**，**耗费空间且执行效率低下**（新建对象、回收对象花费大量时间）。如JSON的封装等。
> 
> 3、在**多线程**情况下，如有大量的字符串操作情况，应该使用StringBuffer。如HTTP参数解析和封装等。

## String常量池

**intern()函数：**

在1.6中，intern的处理是 先判断字符串常量**是否在字符串常量池**中，如果存在直接**返回该常量**，如果没有找到，则将该**字符串常量加入到字符串常量区**，也就是在字符串常量区**建立**该常量；

在1.7中，intern的处理是 先判断字符串常量是否在字符串常量池中，如果存在直接返回该常量，如果没有找到，说明该字符串**常量在堆**中，则处理是把**堆区该对象的\*引用\* 加入到字符串常量池**中，以后别人拿到的是***该字符串常量的引用\***，实际**存在堆**中；【**调用**该方法的**字符串对象**要么**在堆区要么在常量池**中的】

## 常量池的分类【理解即可】

**class文件\*常量池\***

在Class文件中除了有类的版本【高版本可以加载低版本】、字段、方法、接口等描述信息外，还有一项信息是**常量池(Constant Pool Table)【此时没有加载进内存，也就是在文件中】**，用于存放**编译期生成的各种** ***字面量和符号引用\*** **字面量** 字面量类似与我们平常说的常量，主要包括：

1. 文本字符串：就是我们在代码中能够看到的**字符串**，例如String a = “aa”。其中”aa”就是字面量。
2. 被**final修饰**的变量。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   

**符号引用** 主要包括以下常量：

1. 类和接口和全限定名：例如对于String这个类，它的**全限定名**就是java/lang/String。
2. 字段的名称和描述符：所谓字段就是类或者接口中**声明的变量**，包括类级别变量（static)和实例级的变量。
3. 方法的名称和描述符。所谓描述符就相当于方法的**参数类型+返回值类型**。

**运行时常量池**

我们知道类加载器会加载对应的Class文件，而上面的class文件中的常量池，会在类加载后进入**方法区**中的运行时常量池【此时存在在内存中】。并且需要的注意的是，**运行时常量池是全局共享的，多个类共用一个运行时常量池**。并且class文件中常量池多个相同的字符串在运行时常量池**只会存在一份**。 注意运行时常量池存在于**方法区**中。

**字符串常量池**

　　看名字我们就可以知道字符串常量池会用来存放**字符串**，也就是说**常量池中的文本字符串**会在类加载时进入**字符串常量池**。 那字符串常量池和运行时常量池是什么关系呢？上面我们说**常量池中的字面量**会在**类加载后**进入运**行时常量池**，其中字面量中有包括**文本字符串**，显然从这段文字我们可以知道：

***字符串常量池存在于运行时常量池中。也就存在于方法区中。\*** 不过在周志明那本深入java虚拟机中有说到，到了JDK1.7时，字符串常量池就被移出了方法区，*转移到了**堆**里了*。 那么我们可以推断，到了JDK1.7以及之后的版本中，**运行时常量池并没有包含字符串常量池**，运行时常量池存在于**方法区**中，而字符串常量池存在于**堆**中。

## String步骤解析

String str1 = new String("1");　　

解析：首先此行代码创建了两个对象，在执行前会在常量池中创建一个"1"的对象，然后执行该行代码时new一个"1"的对象存放在**堆区**中；然后**str1指向堆区中的对象**；

str1.intern();　　

解析：该行代码首先查看"1"字符串有没有存在在常量池中，此时存在则直接返回该常量，这里返回后没有引用接受他，【假如不存在的话在 jdk1.6中会在常量池中建立该常量，在jdk1.7以后会把**<u>堆中该对象的引用放在常量池中</u>**】

String str2 = "1";　　

解析：此时"1"已经存在在常量池中，str2指向常量池中的对象；

```
 System.out.println(str1 == str2);  //结果是 false or true？　　解析：str1指向堆区的对象，str2指向常量池中的对象，两个引用指向的地址不同，输入false；

    String str3 = new String("2") + new String("2");　　解析：此行代码执行的底层执行过程是 首先使用StringBuffer的append方法将"2"和"2"拼接在一块，然后调用toString方法new出“22”；所以此时的“22”字符串是创建在堆区的；
    t3.intern();　　解析：此行代码执行时字符串常量池中没有"22",所以此时在jdk1.6中会在字符串常量池中创建"22",而在jdk1.7以后会把堆中该对象的引用放在常量池中；
    String str4 = "22";　　解析：此时的str4在jdk1.6中会指向方法区，而在jdk1,7中会指向堆区；
    System.out.println(str3 == str4); //结果是 false or true？　　解析：很明显了 jdk1.6中为false 在jdk1.7中为true；
```

## String类的源码分析

**intern**

```
public void intern () {
    //string的intern使用
    //s1是基本类型，比较值。s2是string实例，比较实例地址
    //字符串类型用equals方法比较时只会比较值
    String s1 = "a";
    String s2 = new String("a");
    //调用intern时,如果s2中的字符不在常量池，则加入常量池并返回常量的引用
    String s3 = s2.intern();
    System.out.println(s1 == s2);
    System.out.println(s1 == s3);
}
```
